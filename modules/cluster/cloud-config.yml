#cloud-config
package_update: true
packages:
  - aws-cfn-bootstrap
  - aws-logs
write_files:
  - path: "/opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json"
    permissions: "0644"
    owner: "root"
    content: |
      {
          "agent": {
              "region": "${region}",
              "metrics_collection_interval": 60,
              "logfile": "/opt/aws/amazon-cloudwatch-agent/logs/amazon-cloudwatch-agent.log"
          },
          "metrics": {
              "metrics_collected": {
                  "disk": {
                      "resources": [
                          "*"
                      ],
                      "measurement": [
                          "disk_used_percent"
                      ],
                      "metrics_collection_interval": 60
                  },
                  "swap": {
                      "measurement": [
                          "swap_used_percent"
                      ],
                      "metrics_collection_interval": 5
                  },
                  "mem": {
                      "measurement": [
                          "mem_used_percent"
                      ],
                      "metrics_collection_interval": 5
                  }
              },
              "append_dimensions": {
                  "ImageId": "$${aws:ImageId}",
                  "InstanceId": "$${aws:InstanceId}",
                  "InstanceType": "$${aws:InstanceType}",
                  "AutoScalingGroupName": "$${aws:AutoScalingGroupName}"
              },
              "aggregation_dimensions": [["InstanceId"], ["AutoScalingGroupName"]]
          },
          "logs": {
              "logs_collected": {
                  "files": {
                      "collect_list": [
                          {
                              "file_path": "/opt/aws/amazon-cloudwatch-agent/logs/amazon-cloudwatch-agent.log*",
                              "log_group_name": "${log_group_name}",
                              "log_stream_name": "{instance_id}/amazon-cloudwatch-agent",
                              "timezone": "UTC"
                          },
                          {
                              "file_path": "/var/log/ecs/ecs-agent.log*",
                              "log_group_name": "${log_group_name}",
                              "log_stream_name": "{instance_id}/amazon-ecs-agent",
                              "timezone": "UTC"
                          }
                      ]
                  }
              },
              "log_stream_name": "{instance_id}/untitled-logs"
          }
      }

  - path: "/etc/ecs/ecs.config"
    permissions: "0744"
    owner: "root"
    content: |
      ECS_CLUSTER=${ecs_cluster_name}
      ECS_LOG_LEVEL=${ecs_log_level}
      ECS_ENABLE_CONTAINER_METADATA=true
      ECS_ENABLE_TASK_IAM_ROLE=true
      ECS_ENABLE_TASK_IAM_ROLE_NETWORK_HOST=true
      ECS_AVAILABLE_LOGGING_DRIVERS=["awslogs"]

runcmd:
  - |
    yum install -y https://amazon-ssm-${region}.s3.amazonaws.com/latest/linux_amd64/amazon-ssm-agent.rpm
  - |
    systemctl enable awslogsd.service
    systemctl start awslogsd
  - |
    systemctl ecs restart
    aws ecs wait services-stable --cluster ${ecs_cluster_name}
    /opt/aws/bin/cfn-signal -e $? --stack ${stack_name} --resource AutoScalingGroup --region ${region}